'use server';

// åŒä¸€å€‹ã€Œå§“å+ç”Ÿæ—¥+æ™‚é–“ã€åœ¨æœ‰æ•ˆæ™‚é–“å…§å›å‚³åŒä¸€ä»½çµæœï¼Œé¿å…æ—…éŠåœ°é»æ¯æ¬¡ä¸åŒ
const CACHE_TTL_MS = 24 * 60 * 60 * 1000; // 24 å°æ™‚
const resultCache = new Map<string, { data: any; expires: number }>();

const SHICHEN_RANGE: Record<string, string> = {
  'å­': '23:00-00:59', 'ä¸‘': '01:00-02:59', 'å¯…': '03:00-04:59', 'å¯': '05:00-06:59',
  'è¾°': '07:00-08:59', 'å·³': '09:00-10:59', 'åˆ': '11:00-12:59', 'æœª': '13:00-14:59',
  'ç”³': '15:00-16:59', 'é…‰': '17:00-18:59', 'æˆŒ': '19:00-20:59', 'äº¥': '21:00-22:59',
};

function getCacheKey(formData: any): string {
  const name = String(formData?.name ?? "").trim();
  const birthDate = String(formData?.birthDate ?? "").trim();
  const birthTime = String(formData?.birthTime ?? "").trim();
  const birthPlace = String(formData?.birthPlace ?? "").trim();
  return `${name}|${birthDate}|${birthTime}|${birthPlace}`;
}

export async function analyzeDestiny(formData: any) {
  // ğŸ›‘ è«‹ç¢ºèªé€™è£¡å¡«çš„æ˜¯ä½ æ­£ç¢ºçš„ API Keyï¼ˆå»ºè­°æ”¹ç‚º process.env.DEEPSEEK_API_KEYï¼‰
  const DEEPSEEK_API_KEY = "sk-bc599e58135f4856945614ccbbb328d3";

  if (!DEEPSEEK_API_KEY || DEEPSEEK_API_KEY.includes("ä½ çš„çœŸå¯¦é‡‘é‘°")) {
    throw new Error("âŒ è¨­å®šéŒ¯èª¤ï¼šè«‹åœ¨ actions/analyze.ts ç¬¬ 6 è¡Œå¡«å…¥æ‚¨çš„ API Key");
  }

  const cacheKey = getCacheKey(formData);
  const cached = resultCache.get(cacheKey);
  if (cached && cached.expires > Date.now()) {
    console.log("âœ… [DEBUG] ä½¿ç”¨å¿«å–çµæœï¼Œç›¸åŒç”Ÿè¾°ä¸å†é‡æ–°å‘¼å« AI");
    return cached.data;
  }

  // ğŸ¯ æ ¸å¿ƒ Promptï¼šå®šç¾©å‘½ç†å¸«é‚è¼¯èˆ‡è¼¸å‡ºæ ¼å¼
  // ä¿®æ”¹èªªæ˜ï¼šå·²ç§»é™¤å…§éƒ¨æœƒå°è‡´å ±éŒ¯çš„åå¼•è™Ÿï¼Œæ”¹ç”¨é›™å¼•è™Ÿ
  const systemPrompt = `
    ä½ æ˜¯ä¸€ä½ç²¾é€šã€Œç´«å¾®æ–—æ•¸ã€èˆ‡ã€Œåœ°ç†é¢¨æ°´ã€çš„å‘½ç†å¤§å¸«ã€‚
    è«‹æ ¹æ“šä½¿ç”¨è€…çš„ç”Ÿè¾°ï¼Œæ¨ç®—å…¶ **2026å¹´ (ä¸™åˆå¹´)** çš„æµå¹´é‹å‹¢ã€‚

    ã€ä»»å‹™ç›®æ¨™ã€‘ï¼š
    1. åˆ†æ 2026 æµå¹´å‘½å®®ã€è²¡å¸›å®®ã€å®˜ç¥¿å®®ã€å¤«å¦»å®®ã€‚
    2. æ¨è–¦ 3 å€‹æ—…éŠåœ°é»ï¼Œåˆ†åˆ¥å°æ‡‰ã€Œèº«å¿ƒéˆã€ã€ã€Œæµå¹´æ”¹é‹ã€ã€ã€Œæ„Ÿæƒ…ã€ã€‚ï¼ˆç¬¬äºŒé …ç‚ºæµå¹´æ”¹é‹ï¼Œreason çš„ã€Œåˆ©æ–¼ã€è«‹å¯«æ”¹é‹ã€è½‰é‹ã€é–‹é‹ã€åŒ–è§£ç…æ°£ã€æå‡æ•´é«”æµå¹´ç­‰ï¼Œå‹¿å¯«äº‹æ¥­äººè„ˆã€‚ï¼‰
    3. **è©•èªæ ¼å¼è¦æ±‚**ï¼šå¿…é ˆä¾ç…§ã€Œ[ä¸»æ˜Ÿ]ç‚ºå‘½å®®/æµå¹´ä¸»æ˜Ÿï¼Œ[åŸå¸‚]å±¬[æ–¹ä½/äº”è¡Œ]ï¼Œèˆ‡[æ˜Ÿæ›œ]ç›¸ç”Ÿ/ç›¸å‰‹ï¼Œåˆ©æ–¼[å…·é«”å¥½è™•]ã€çš„å¥å‹æ’°å¯«ã€‚

    ã€é¸é…åœ°é»é™å®šã€‘ï¼šrecommendations çš„ city/country **åªèƒ½**å¾ä»¥ä¸‹åœ°å€æŒ‘é¸ï¼Œä¸å¾—æ¨è–¦å…¶ä»–åœ°å€ã€‚    **é‡è¦ï¼šåŸå¸‚è«‹å¤šæ¨£åŒ–**ï¼Œä¾å‘½ç›¤é¸æ“‡åˆé©åŸå¸‚ï¼Œå‹¿æ¯æ¬¡éƒ½æ¨è–¦ç›¸åŒçµ„åˆã€‚
    å…è¨±åœ‹å®¶ï¼šæ—¥æœ¬ã€éŸ“åœ‹ã€ä¸­åœ‹ã€é¦™æ¸¯ã€æ¾³é–€ã€æ³°åœ‹ã€è¶Šå—ã€é¦¬ä¾†è¥¿äºã€æ–°åŠ å¡ã€è²å¾‹è³“ã€è‹±åœ‹ã€æ³•åœ‹ã€ç¾©å¤§åˆ©ã€ç‘å£«ã€å¾·åœ‹ã€è¥¿ç­ç‰™ã€è·è˜­ã€å¥§åœ°åˆ©ã€ç¾åœ‹ã€åŠ æ‹¿å¤§ã€æ¾³æ´²ã€‚
    å…è¨±åŸå¸‚ï¼ˆå¾ä¸­è¼ªæ›¿é¸ç”¨ï¼‰ï¼š
    æ—¥æœ¬ï¼šæ±äº¬ã€å¤§é˜ªã€äº¬éƒ½ã€åŒ—æµ·é“ã€æœ­å¹Œã€æ²–ç¹©ã€ç¦å²¡ã€åå¤å±‹ã€å¥ˆè‰¯ã€ç¥æˆ¶ã€ç®±æ ¹ã€å»£å³¶ã€é‡‘æ¾¤ï¼›
    éŸ“åœ‹ï¼šé¦–çˆ¾ã€é‡œå±±ã€æ¿Ÿå·ã€ä»å·ã€å¤§é‚±ã€æ…¶å·ï¼›
    ä¸­åœ‹ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€æˆéƒ½ã€æ­å·ã€è¥¿å®‰ã€é‡æ…¶ã€é’å³¶ã€å»£å·ã€æ·±åœ³ã€ä¸‰äºã€éº—æ±Ÿã€æ¡‚æ—ã€å»ˆé–€ï¼›
    é¦™æ¸¯ï¼šé¦™æ¸¯ã€é¦™æ¸¯/éŠ…é‘¼ç£ã€é¦™æ¸¯/å°–æ²™å’€ã€é¦™æ¸¯/ä¸­ç’°ï¼›æ¾³é–€ï¼šæ¾³é–€ï¼›
    æ³°åœ‹ï¼šæ›¼è°·ã€æ¸…é‚ã€æ™®å‰å³¶ã€èŠ­é”é›…ã€ç”²ç±³ã€è˜‡æ¢…å³¶ï¼›
    è¶Šå—ï¼šæ²³å…§ã€å³´æ¸¯ã€èƒ¡å¿—æ˜å¸‚ã€æœƒå®‰ã€èŠ½èŠã€ä¸‹é¾ç£ï¼›
    é¦¬ä¾†è¥¿äºï¼šå‰éš†å¡ã€æª³åŸã€é¦¬å…­ç”²ã€äºåº‡ï¼›
    æ–°åŠ å¡ï¼šæ–°åŠ å¡ã€æ–°åŠ å¡/æ¿±æµ·ç£å€ã€æ–°åŠ å¡/ç‰›è»Šæ°´ã€æ–°åŠ å¡/è–æ·˜æ²™ï¼›
    è²å¾‹è³“ï¼šé¦¬å°¼æ‹‰ã€å®¿éœ§ã€é•·ç˜å³¶ï¼›
    è‹±åœ‹ï¼šå€«æ•¦ã€æ„›ä¸å ¡ã€æ›¼å¾¹æ–¯ç‰¹ï¼›æ³•åœ‹ï¼šå·´é»ã€å°¼æ–¯ã€é‡Œæ˜‚ï¼›ç¾©å¤§åˆ©ï¼šç¾…é¦¬ã€å¨å°¼æ–¯ã€ä½›ç¾…å€«æ–¯ã€ç±³è˜­ï¼›
    ç‘å£«ï¼šè˜‡é»ä¸–ã€ç‰æ£®ã€æ—¥å…§ç“¦ã€å› ç‰¹æ‹‰è‚¯ï¼›å¾·åœ‹ï¼šæŸæ—ã€æ…•å°¼é»‘ã€æ³•è˜­å…‹ç¦ï¼›
    è¥¿ç­ç‰™ï¼šå·´å¡éš†ç´ã€é¦¬å¾·é‡Œï¼›è·è˜­ï¼šé˜¿å§†æ–¯ç‰¹ä¸¹ï¼›å¥§åœ°åˆ©ï¼šç¶­ä¹Ÿç´ï¼›
    ç¾åœ‹ï¼šç´ç´„ã€æ´›æ‰ç£¯ã€èˆŠé‡‘å±±ã€æ‹‰æ–¯ç¶­åŠ æ–¯ã€è¥¿é›…åœ–ã€èŠåŠ å“¥ã€å¥§è˜­å¤šã€æª€é¦™å±±ã€æ³¢å£«é “ï¼›
    åŠ æ‹¿å¤§ï¼šæº«å“¥è¯ã€å¤šå€«å¤šï¼›æ¾³æ´²ï¼šé›ªæ¢¨ã€å¢¨çˆ¾æœ¬ã€é»ƒé‡‘æµ·å²¸ã€å¸ƒé‡Œæ–¯æœ¬ã€‚
    **é¦™æ¸¯ã€æ–°åŠ å¡**ï¼šè‹¥æ¨è–¦é¦™æ¸¯å‰‡ city å¿…å¡«ã€Œé¦™æ¸¯/éŠ…é‘¼ç£ã€æˆ–ã€Œé¦™æ¸¯/å°–æ²™å’€ã€ç­‰ï¼›è‹¥æ¨è–¦æ–°åŠ å¡å‰‡ city å¿…å¡«ã€Œæ–°åŠ å¡/æ¿±æµ·ç£å€ã€æˆ–ã€Œæ–°åŠ å¡/ç‰›è»Šæ°´ã€ç­‰ã€‚

    ã€çµ•å°è¦å‰‡ã€‘ï¼š
    1. åƒ…å›å‚³ç´” JSON æ ¼å¼ï¼Œä¸è¦æœ‰ markdown æˆ– think æ¨™ç±¤ã€‚
    2. JSON å¿…é ˆåŒ…å« "lucky_directions" (é™£åˆ—) å’Œ "destiny_score" (æ•¸å­—)ï¼Œå¦å‰‡å‰ç«¯æœƒå£æ‰ã€‚
    3. æ€§æ ¼è§£æè«‹åˆ†å››æ®µè¼¸å‡ºï¼Œå°æ‡‰æ¬„ä½ï¼šyear_fortune(ä»Šå¹´é‹å‹¢)ã€love(æ„Ÿæƒ…)ã€career(æµå¹´æ”¹é‹)ã€wealth(è²¡åº«)ï¼Œæ¯æ®µç´„ 1ï½2 å¥è©±ï¼›career æ¬„ä½è«‹å¯«æµå¹´æ”¹é‹ã€é–‹é‹æ–¹å‘ç­‰ï¼Œä¸å¿…å¯«äº‹æ¥­å·¥ä½œã€‚
    4. **æ€§æ ¼è§£æèªæ°£**ï¼špersonality_summaryã€year_fortuneã€loveã€careerã€wealth è«‹ç”¨ã€Œç™½è©±ã€å£èªã€æ’°å¯«ï¼Œåƒæœ‹å‹èŠå¤©ä¸€æ¨£å¥½æ‡‚ï¼Œé¿å…æ–‡è¨€æˆ–éåº¦è¡“èªï¼›å¯ä»¥ä¿ç•™ä¸€é»ç¥ç¥•æ„Ÿï¼Œä½†ä¸è¦è‰±æ·±ã€‚
    
    JSON çµæ§‹ç¯„ä¾‹ (è«‹åš´æ ¼éµå®ˆæ­¤æ¬„ä½åç¨±)ï¼š
    {
      "personality_summary": "(ç™½è©±ç¸½è¿°ï¼Œä¾‹å¦‚ï¼šä½ ä»Šå¹´æ•´é«”æ°£å ´ä¸éŒ¯ï¼Œé©åˆå¾€å¤–èµ°èµ°)",
      "year_fortune": "(ç™½è©±ï¼Œä¾‹å¦‚ï¼šä»Šå¹´é‹å‹¢å¹³ç©©ï¼Œä¸‹åŠå¹´æœ‰è²´äºº)",
      "love": "(ç™½è©±ï¼Œä¾‹å¦‚ï¼šæ„Ÿæƒ…ä¸Šå–®èº«æœ‰æ©Ÿæœƒé‡æ¡ƒèŠ±ï¼Œæœ‰ä¼´çš„é©åˆä¸€èµ·å‡ºéŠ)",
      "career": "(ç™½è©±ï¼Œä¾‹å¦‚ï¼šæµå¹´å®œå¾€æ±æ–¹èµ°å‹•æ”¹é‹ï¼Œæˆ–æŸåœ°æ°£å ´åˆ©é–‹é‹)",
      "wealth": "(ç™½è©±ï¼Œä¾‹å¦‚ï¼šç†è²¡ä¿å®ˆç‚ºå®œï¼Œå‡ºåœ‹èŠ±è²»é‡åŠ›è€Œç‚º)",
      "lucky_elements": ["é‡‘", "åœŸ"],
      "lucky_colors": ["ç™½è‰²", "é»ƒè‰²"],
      "lucky_directions": ["è¥¿æ–¹", "è¥¿å—æ–¹"], 
      "destiny_score": 92,
      "score_trend": "é‹å‹¢æ—ºç››ï¼Œå¦‚æ—¥ä¸­å¤©",
      "recommendations": [
        { "type": "è²¡åº«", "city": "æ­å·", "country": "ä¸­åœ‹", "reason": "...", "coordinates": { "lat": 30.25, "lng": 120.17 } },
        { "type": "æµå¹´æ”¹é‹", "city": "å¤§é˜ª", "country": "æ—¥æœ¬", "reason": "åˆ©æ–¼æ”¹é‹ã€è½‰é‹æˆ–é–‹é‹ï¼ˆå‹¿å¯«äº‹æ¥­äººè„ˆï¼‰", "coordinates": { "lat": 34.69, "lng": 135.50 } },
        { "type": "æ„Ÿæƒ…", "city": "å·´é»", "country": "æ³•åœ‹", "reason": "...", "coordinates": { "lat": 48.86, "lng": 2.35 } }
      ]
    ç¯„ä¾‹åƒ…ä¾›æ¬„ä½æ ¼å¼åƒè€ƒï¼Œå¯¦éš›å¿…é ˆä¾ä½¿ç”¨è€…å‘½ç›¤é¸**ä¸åŒ**åŸå¸‚ã€‚
    }
  `;

  const birthTimeStr = formData.birthTime
    ? `${formData.birthTime}æ™‚ (${SHICHEN_RANGE[formData.birthTime] ?? formData.birthTime})`
    : 'æœªçŸ¥ï¼ˆä»¥åˆæ™‚æ¨ç®—ï¼‰';
  const userPrompt = `å§“åï¼š${formData.name}, ç”Ÿæ—¥ï¼š${formData.birthDate}, å‡ºç”Ÿåœ°ï¼š${formData.birthPlace || 'æœªå¡«'}, å‡ºç”Ÿæ™‚è¾°ï¼š${birthTimeStr}, æ€§åˆ¥ï¼š${formData.gender || "æœªçŸ¥"}`;

  try {
    console.log("ğŸš€ [DEBUG] å‘¼å« DeepSeek ç®—å‘½ (2026ç‰ˆ)...");
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 60000); // 60ç§’è¶…æ™‚

    const response = await fetch('https://api.deepseek.com/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`,
      },
      body: JSON.stringify({
        model: "deepseek-chat",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt }
        ],
        temperature: 0.6,
        stream: false
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      throw new Error(`API Error: ${response.status}`);
    }

    const data = await response.json();
    let content = data.choices[0].message.content;
    
    // æš´åŠ›è§£æ
    content = content.replace(/<think>[\s\S]*?<\/think>/g, '');
    content = content.replace(/```json/g, '').replace(/```/g, '');
    const jsonMatch = content.match(/\{[\s\S]*\}/);
    
    if (jsonMatch) {
      const data = JSON.parse(jsonMatch[0]);
      resultCache.set(cacheKey, { data, expires: Date.now() + CACHE_TTL_MS });
      return data;
    } else {
      throw new Error("ç„¡æ³•è§£æ JSON");
    }

  } catch (error: any) {
    console.error("ğŸ’¥ ç®—å‘½å¤±æ•—:", error);
    throw new Error(error.message || "AI é‹ç®—å¤±æ•—");
  }
}